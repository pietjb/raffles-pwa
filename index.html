<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2c5282">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Multi-Raffle System</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="A system to manage multiple raffles and their tickets">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f5f7fa">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#2c5282">
    
    <!-- Android Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
    
    <link rel="stylesheet" href="/style.css">
    
    <!-- Add inline style to ensure login shows first -->
    <style>
        #login-screen {
            display: flex !important;
        }
        #app-content {
            display: none !important;
        }
    </style>
    
    <!-- Load config.js BEFORE script.js with cache busting -->
    <script src="/config.js?v=2"></script>
    <script src="/script.js?v=2"></script>

    <!-- PWA Install Prompt Handler -->
    <script>
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('PWA install prompt available');
            
            // Show custom install button if needed
            const installBtn = document.createElement('button');
            installBtn.textContent = 'Install App';
            installBtn.classList.add('install-button');
            installBtn.style.display = 'none';  // Hide by default
            document.body.appendChild(installBtn);
            
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to install prompt: ${outcome}`);
                    deferredPrompt = null;
                    installBtn.style.display = 'none';
                }
            });
        });

        window.addEventListener('appinstalled', (evt) => {
            console.log('App was installed');
        });
    </script>
</head>
<body>
    <!-- Blocking script to ensure login shows first -->
    <script>
        // This executes IMMEDIATELY as the page renders
        document.write('<style>#app-content{display:none !important;visibility:hidden !important;}#login-screen{display:flex !important;visibility:visible !important;}</style>');
    </script>
    
    <!-- Login Screen (must be first and visible) -->
    <div id="login-screen">
        <div class="login-container">
            <h1>üéüÔ∏è Raffle System</h1>
            <div class="login-form">
                <input 
                    type="password" 
                    id="access-password" 
                    placeholder="Enter password"
                    autocomplete="off"
                />
                <button onclick="verifyAccess()">Login</button>
                <div id="login-error" class="error-message"></div>
            </div>
        </div>
    </div>

    <!-- Main App Content (hidden until login) -->
    <div id="app-content">
        <!-- Raffle Selector Section -->
        <section id="raffle-selector">
            <h2>Select Raffle</h2>
            <div id="raffle-list"></div>
            <button onclick="showNewRaffleForm()">Create New Raffle</button>
        </section>

        <!-- New Raffle Form Section -->
        <section id="new-raffle-form" style="display: none;">
            <h2>Create New Raffle</h2>
            
            <div class="form-section">
                <h3 class="form-section-title">Basic Information</h3>
                <div class="form-group">
                    <label for="raffle-name">Raffle Name <span class="required">*</span></label>
                    <input id="raffle-name" placeholder="Enter raffle name" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="draw-date">Draw Date <span class="required">*</span></label>
                        <input id="draw-date" type="date" required>
                    </div>
                    <div class="form-group">
                        <label for="ticket-cost">Ticket Cost (R) <span class="required">*</span></label>
                        <input id="ticket-cost" type="number" step="5" min="10" value="10" placeholder="10" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="prize">Prize Description <span class="required">*</span></label>
                    <input id="prize" placeholder="Describe the prize" required>
                </div>
            </div>
            
            <div class="form-section">
                <h3 class="form-section-title">Payment Details</h3>
                <div class="form-group">
                    <label for="payment-link">Capitec Payment Link <span class="required">*</span></label>
                    <input id="payment-link" type="url" placeholder="https://paylink.capitecbank.co.za/..." required>
                    <small class="form-hint">For Capitec account holders only</small>
                </div>
            </div>
            
            <div class="form-section">
                <h3 class="form-section-title">Advertisement Image</h3>
                <div class="form-group">
                    <label for="raffle-image">Upload Image <span class="optional">(optional)</span></label>
                    <input id="raffle-image" type="file" accept="image/*" class="file-input">
                    <small class="form-hint">Upload an image to advertise your raffle</small>
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-checkbox">
                    <input type="checkbox" id="banking-required" onchange="toggleBankingDetails(this.checked)">
                    <label for="banking-required">Include banking details for payments</label>
                </div>
            </div>
            
            <div id="banking-details-section" class="form-section" style="display: none;">
                <h3 class="form-section-title">Banking Details</h3>
                <div class="form-group">
                    <label for="account-owner">Account Owner</label>
                    <input id="account-owner" placeholder="Full name on account">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="bank-name">Bank Name</label>
                        <input id="bank-name" placeholder="e.g., Capitec Bank">
                    </div>
                    <div class="form-group">
                        <label for="branch-code">Branch Code</label>
                        <input id="branch-code" placeholder="e.g., 470010">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="account-number">Account Number</label>
                        <input id="account-number" placeholder="Enter account number">
                    </div>
                    <div class="form-group">
                        <label for="account-type">Account Type</label>
                        <select id="account-type">
                            <option value="">Select type</option>
                            <option value="Savings">Savings</option>
                            <option value="Cheque">Cheque</option>
                            <option value="Current">Current</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button onclick="createRaffle()" class="btn-primary">Create Raffle</button>
                <button onclick="showRaffleSelector()" class="btn-secondary">Cancel</button>
            </div>
        </section>

        <!-- Raffle Content Section -->
        <div id="raffle-content" style="display: none;">
            <button class="back-btn" onclick="showRaffleSelector()">Back to Raffles</button>
            <section class="raffle-header">
                <h2 id="current-raffle-name"></h2>
                <div class="raffle-info">
                    <p>Draw Date: <span id="draw-date-display"></span></p>
                    <p>Prize: <span id="prize-display"></span></p>
                    <p>Ticket Cost: <span id="ticket-cost-display"></span></p>
                </div>
                <button onclick="showRaffleSelector()" class="secondary">Change Raffle</button>
            </section>

            <!-- Existing buyer form and sections -->
            <section>
                <h2>Add Buyer</h2>
                <div class="buyer-form">
                    <div class="form-section">
                        <h3 class="form-section-title">Buyer Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="name">First Name <span class="required">*</span></label>
                                <input id="name" placeholder="Enter first name" required>
                            </div>
                            <div class="form-group">
                                <label for="surname">Surname <span class="required">*</span></label>
                                <input id="surname" placeholder="Enter surname" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mobile">Mobile Number <span class="optional">(optional)</span></label>
                                <input id="mobile" type="tel" placeholder="e.g., 082 123 4567">
                            </div>
                            <div class="form-group">
                                <label for="email">Email Address <span class="required">*</span></label>
                                <input id="email" type="email" placeholder="email@example.com" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 class="form-section-title">Purchase Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tickets">Number of Tickets <span class="required">*</span></label>
                                <input id="tickets" type="number" min="1" value="1" placeholder="1" required>
                            </div>
                            <div class="form-group">
                                <label for="purchaseDate">Purchase Date <span class="required">*</span></label>
                                <input id="purchaseDate" type="date" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button onclick="addBuyer()" class="btn-primary">Add Buyer</button>
                    </div>
                </div>
            </section>

            <section>
                <h2>All Buyers</h2>
                <div id="buyers"></div>
            </section>

            <section>
                <h2>Draw Winner</h2>
                <button onclick="drawWinner()">Draw Winner</button>
                <div id="winner"></div>
            </section>
        </div>
    </div>
</body>
</html>
